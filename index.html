<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <title>ค้นหาข้อมูลสถานที่สอบ ภาคเหนือ เขต 2</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Font Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="styles.css">

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<div class="container glass">
    <h1>ค้นหาข้อมูลสถานที่สอบ ภาคเหนือ เขต 2</h1>

    <div class="search-box">
        <input
            type="text"
            id="keywordInput"
            class="input-text"
            placeholder="กรอกเลขประจำตัวสอบ เช่น 1210100001"
        />
        <button id="searchBtn" class="btn-primary">ค้นหา</button>
    </div>

    <div id="statusText" class="status">รอค้นหา...</div>

    <div class="table-wrapper">
        <table>
            <thead>
            <tr>
                <th>ตำแหน่ง</th>
                <th>เลขประจำตัวสอบ</th>
                <th>จังหวัด</th>
                <th>สนามสอบ</th>
                <th>อาคาร</th>
                <th>ชั้น</th>
                <th>ห้องสอบที่</th>
            </tr>
            </thead>
            <tbody id="resultBody">
                <tr><td colspan="7" class="no-data">ยังไม่มีข้อมูล</td></tr>
            </tbody>
        </table>
    </div>

    <div class="note">
        <strong>หมายเหตุ :</strong>
        ระบบนี้จัดทำขึ้นเพื่อช่วยค้นหาข้อมูลสถานที่สอบ ภาคเหนือ เขต 2 แบบคร่าว ๆ เท่านั้น  
        โปรดตรวจสอบกับไฟล์ประกาศจริงอีกครั้งที่  
        <a href="https://drive.google.com/file/d/1eqxkGzsW6e2NSL-1lXTyBbJxEY52feLe/view" target="_blank">
            คลิกที่นี่
        </a>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzM2GT5Lt_T_054PvGgi3u9mgNTgBVBC2cOur7NZCHWEoqRAorzLLwlFw9hD58iIfTyFQ/exec"; // ← เปลี่ยนเป็น Web App ของคุณ

    document.addEventListener("DOMContentLoaded", () => {
        Swal.fire({
            icon: 'info',
            title: 'คำเตือนการใช้งาน',
            html: `
                ระบบนี้ใช้เพื่อช่วยค้นหาข้อมูลแบบคร่าว ๆ เท่านั้น<br>
                โปรดตรวจสอบข้อมูลจากไฟล์ประกาศจริงที่<br>
                <a href="https://drive.google.com/file/d/1eqxkGzsW6e2NSL-1lXTyBbJxEY52feLe/view" target="_blank">
                    คลิกที่นี่
                </a>
            `,
            confirmButtonText: 'รับทราบ'
        });

        document.getElementById("searchBtn").addEventListener("click", handleSearch);
        document.getElementById("keywordInput").addEventListener("keyup", e => {
            if (e.key === "Enter") handleSearch();
        });
    });

    async function handleSearch() {
        const keyword = document.getElementById("keywordInput").value.trim();
        const statusEl = document.getElementById("statusText");

        if (!keyword) {
            Swal.fire({
                icon: 'warning',
                title: 'ยังไม่ได้กรอกเลขประจำตัวสอบ',
                text: 'กรุณากรอกเลขก่อนทำการค้นหา',
                confirmButtonText: 'ตกลง'
            });
            return;
        }

        Swal.fire({
            title: 'กำลังค้นหา...',
            html: 'ระบบกำลังดึงข้อมูลจากฐานข้อมูล<br>โปรดรอสักครู่',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => Swal.showLoading()
        });

        const url = `${API_URL}?field=${encodeURIComponent("เลขประจำตัวสอบ")}&keyword=${encodeURIComponent(keyword)}`;

        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error("HTTP " + res.status);

            const json = await res.json();
            Swal.close();

            renderRows(json.data || []);
            statusEl.textContent = `พบข้อมูล ${json.total} รายการ`;

            if (!json.data || json.data.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่พบข้อมูล',
                    html: `
                        ไม่พบเลขประจำตัวสอบที่ค้นหา<br>
                        โปรดตรวจสอบจากไฟล์ประกาศจริงอีกครั้งที่<br>
                        <a href="https://drive.google.com/file/d/1eqxkGzsW6e2NSL-1lXTyBbJxEY52feLe/view" target="_blank">
                            คลิกที่นี่
                        </a>
                    `,
                    confirmButtonText: 'ตกลง'
                });
            }
        } catch (err) {
            Swal.close();
            statusEl.textContent = "เกิดข้อผิดพลาด: " + err.message;
            renderRows([]);

            Swal.fire({
                icon: 'error',
                title: 'การเชื่อมต่อล้มเหลว',
                text: 'ไม่สามารถเชื่อมต่อกับ API ได้ โปรดลองใหม่อีกครั้ง',
                confirmButtonText: 'ตกลง'
            });
        }
    }

    function renderRows(rows) {
        const tbody = document.getElementById("resultBody");
        tbody.innerHTML = "";

        if (!rows || rows.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="no-data">ไม่พบข้อมูล</td></tr>`;
            return;
        }

        rows.forEach(r => {
            const tr = document.createElement("tr");

            addCell(tr, r["ตำแหน่ง"], "ตำแหน่ง");
            addCell(tr, r["เลขประจำตัวสอบ"], "เลขประจำตัวสอบ");
            addCell(tr, r["จังหวัด"], "จังหวัด");
            addCell(tr, r["สนามสอบ"], "สนามสอบ");
            addCell(tr, r["อาคาร"], "อาคาร");
            addCell(tr, r["ชั้น"], "ชั้น");
            addCell(tr, r["ห้องสอบที่"], "ห้องสอบที่");

            tbody.appendChild(tr);
        });
    }

    function addCell(tr, text, label) {
        const td = document.createElement("td");
        td.textContent = text ?? "";
        td.setAttribute("data-label", label); // ใช้กับการ์ดบนมือถือ
        tr.appendChild(td);
    }
</script>

</body>
</html>
